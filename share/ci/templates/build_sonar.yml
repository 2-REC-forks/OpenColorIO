# azure-pipelines template file
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops

# Note: This is currently Linux only

steps:
- bash: |
    cd /var/opt
    ls
    find -name "*build-wrapper*"
    cd /usr
    find -name "*build-wrapper*"
    echo $PATH
    echo $SONAR_RUNNER_HOME
    /var/opt/build-wrapper-linux-x86/build-wrapper-linux-x86-64 --help
    /var/opt/sonar-scanner-3.3.0.1492-linux/bin/sonar-scanner --help
    export PATH="$(dirname $(find -name "*/build-wrapper-linux-x86-64")):$PATH"
    export PATH="$(dirname $(find -name "*/sonar-scanner")):$PATH"
    export SONAR_RUNNER_HOME="$(dirname $(find -name "*/sonar-scanner"))"

- bash: build-wrapper-linux-x86-64 --out-dir bw_output make clean all
  workingDirectory: _build
  displayName: Build OCIO with build-wrapper

- template: test.yml

- bash: share/ci/scripts/run_gcov.sh
  displayName: Generate code coverage report

- bash: sonar-scanner -X -Dsonar.login=$SONAR_TOKEN
  env:
    SONAR_TOKEN: $(tokens.sonarCloud)
  displayName: Run sonar-scanner
